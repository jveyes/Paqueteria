{% extends "components/base.html" %}

{% block title %}Mensajes - PAQUETES EL CLUB v3.1{% endblock %}

{% block content %}
<!-- Verificaci√≥n de autenticaci√≥n -->
{% if not is_authenticated %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 sm:py-8">
    <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-8 text-center">
        <div class="bg-gray-100 rounded-lg p-3 inline-flex mx-auto mb-4">
            <svg class="w-8 h-8 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
            </svg>
        </div>
        <h3 class="text-lg font-medium text-gray-900">Acceso Restringido</h3>
        <p class="mt-2 text-sm text-gray-500">Debes iniciar sesi√≥n para acceder a los mensajes.</p>
        <div class="mt-6">
            <a href="/auth/login" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-lg text-white bg-papyrus-blue hover:bg-blue-700 transition-colors duration-200">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path>
                </svg>
                Iniciar Sesi√≥n
            </a>
        </div>
    </div>
</div>
{% else %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 sm:py-8">
    <div class="space-y-6">
        <!-- Header -->
        <div class="sm:flex sm:items-center sm:justify-between">
            <div>
                <h1 class="text-xl sm:text-2xl md:text-3xl font-light text-gray-900">Mensajes</h1>
                <p class="mt-2 text-sm text-gray-500">
                    Gesti√≥n de consultas y mensajes de clientes
                </p>
            </div>
        </div>

        <!-- Estad√≠sticas -->
        <div id="messageStats" class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6 sm:mb-8">
            <!-- No Le√≠dos (Mensajes Nuevos) -->
            <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-lg hover:border-blue-300 transition-all duration-200 cursor-pointer transform hover:scale-105" onclick="filterByStatus('unread')">
                <div class="flex items-center space-x-3">
                    <div class="bg-blue-100 rounded-lg p-2">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-gray-600 uppercase tracking-wide">No Le√≠dos</h3>
                        <p id="unreadMessages" class="text-2xl font-bold text-gray-900">-</p>
                    </div>
                </div>
            </div>

            <!-- Pendientes -->
            <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-lg hover:border-red-300 transition-all duration-200 cursor-pointer transform hover:scale-105" onclick="filterByStatus('pending')">
                <div class="flex items-center space-x-3">
                    <div class="bg-red-100 rounded-lg p-2">
                        <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-gray-600 uppercase tracking-wide">Pendientes</h3>
                        <p id="pendingMessages" class="text-2xl font-bold text-gray-900">-</p>
                    </div>
                </div>
            </div>

            <!-- Cerrados -->
            <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-lg hover:border-green-300 transition-all duration-200 cursor-pointer transform hover:scale-105" onclick="filterByStatus('closed')">
                <div class="flex items-center space-x-3">
                    <div class="bg-green-100 rounded-lg p-2">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-gray-600 uppercase tracking-wide">Cerrados</h3>
                        <p id="closedMessages" class="text-2xl font-bold text-gray-900">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-4 sm:p-6">
            <div class="flex flex-col lg:flex-row lg:items-center lg:space-x-6">
                <h2 class="text-lg font-medium text-gray-900 mb-4 lg:mb-0 lg:flex-shrink-0">Filtros</h2>
                
                <div class="flex flex-col sm:flex-row sm:items-center gap-4 w-full">
                    <!-- Filtros ocultos (mantenidos para funcionalidad) -->
                    <div class="hidden">
                        <select id="statusFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-papyrus-blue focus:ring-1 focus:ring-papyrus-blue bg-white transition-colors appearance-none text-sm">
                            <option value="">Todos los estados</option>
                            <option value="unread">No Le√≠dos</option>
                            <option value="pending">Pendientes</option>
                            <option value="in_progress">En Progreso</option>
                            <option value="resolved">Resueltos</option>
                            <option value="closed">Cerrados</option>
                        </select>
                    </div>

                    <div class="hidden">
                        <select id="priorityFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-papyrus-blue focus:ring-1 focus:ring-papyrus-blue bg-white transition-colors appearance-none text-sm">
                            <option value="">Todas las prioridades</option>
                            <option value="urgent">Urgente</option>
                            <option value="high">Alta</option>
                            <option value="normal">Normal</option>
                            <option value="low">Baja</option>
                        </select>
                    </div>

                    <div class="hidden">
                        <select id="typeFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-papyrus-blue focus:ring-1 focus:ring-papyrus-blue bg-white transition-colors appearance-none text-sm">
                            <option value="">Todos los tipos</option>
                            <option value="customer_inquiry">Consulta de Cliente</option>
                            <option value="support">Soporte</option>
                            <option value="internal">Interno</option>
                            <option value="system">Sistema</option>
                        </select>
                    </div>

                    <div class="hidden">
                        <input id="unreadOnly" type="checkbox" class="h-4 w-4 text-papyrus-blue focus:ring-papyrus-blue border-gray-300 rounded">
                    </div>

                    <!-- B√∫squeda por cliente -->
                    <div class="relative flex-1 min-w-0">
                        <input id="searchFilter" 
                               type="text" 
                               placeholder="Buscar por nombre, tel√©fono o contenido..."
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-papyrus-blue focus:ring-1 focus:ring-papyrus-blue bg-white transition-colors text-sm">
                    </div>

                    <!-- Botones de acci√≥n -->
                    <div class="flex items-center gap-2 flex-shrink-0">
                        <!-- Bot√≥n de limpiar filtros (solo icono) -->
                        <button id="clearFilters" 
                                class="inline-flex items-center justify-center w-10 h-10 border border-gray-300 rounded-lg shadow-sm text-gray-700 bg-white hover:bg-gray-50 hover:shadow-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-papyrus-blue"
                                title="Limpiar filtros">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>

                        
                    </div>
                </div>
            </div>
        </div>

        <!-- Lista de Mensajes -->
        <div class="bg-white rounded-xl shadow-lg border border-gray-100">
            <div class="border-b border-gray-100 px-4 sm:px-8 py-4 sm:py-6">
                <h2 class="text-lg font-medium text-gray-900">Lista de Mensajes</h2>
            </div>
            <div class="p-4 sm:p-8">
                <div id="messagesList" class="space-y-4">
                    <!-- Los mensajes se cargar√°n aqu√≠ din√°micamente -->
                </div>

                <!-- Loading -->
                <div id="messagesLoading" class="text-center py-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-papyrus-blue mx-auto"></div>
                    <p class="mt-2 text-sm text-gray-500">Cargando mensajes...</p>
                </div>

                <!-- Sin mensajes -->
                <div id="noMessages" class="text-center py-8 hidden">
                    <div class="bg-gray-100 rounded-lg p-3 inline-flex mx-auto mb-4">
                        <svg class="w-8 h-8 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                    </div>
                    <h3 class="text-lg font-medium text-gray-900">No hay mensajes</h3>
                    <p class="mt-2 text-sm text-gray-500">No se encontraron mensajes con los filtros aplicados.</p>
                </div>
            </div>
            
            <!-- Paginaci√≥n -->
            <div id="pagination" class="hidden"></div>
        </div>
    </div>
</div>

<!-- Modal de Detalle de Mensaje -->
<div id="messageModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-4 sm:p-5 w-11/12 md:w-3/4 lg:w-1/2 max-w-4xl">
        <div class="bg-white rounded-xl shadow-lg border border-gray-100">
            <div class="border-b border-gray-100 px-4 sm:px-8 py-4 sm:py-6 flex items-center justify-between">
                <h3 class="text-xl font-light text-gray-900">Detalle del Mensaje</h3>
                <button id="closeModal" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="p-4 sm:p-8">
                <div id="messageDetail" class="space-y-6">
                    <!-- El contenido del mensaje se cargar√° aqu√≠ -->
                </div>

                <!-- Formulario de respuesta -->
                <div id="responseForm" class="mt-6 pt-6 border-t border-gray-200">
                    <h4 class="text-lg font-medium text-gray-900 mb-4">Responder al Mensaje</h4>
                    <div class="relative">
                        <textarea id="responseText" 
                                  rows="4" 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-papyrus-blue focus:ring-1 focus:ring-papyrus-blue transition-colors"
                                  placeholder="Escribe tu respuesta..."
                                  maxlength="2000"
                                  oninput="updateResponseCounter()"></textarea>
                        <div id="responseCounter" class="absolute bottom-2 right-2 text-xs text-gray-500 bg-white px-1 rounded">
                            0/2000
                        </div>
                    </div>
                    <div class="mt-4 flex flex-col sm:flex-row sm:justify-end space-y-2 sm:space-y-0 sm:space-x-3">
                        <button id="cancelResponse" 
                                class="w-full sm:w-auto px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 hover:shadow-md transition-all duration-200">
                            Cancelar
                        </button>
                        <button id="sendResponse" 
                                class="w-full sm:w-auto px-4 py-2 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-papyrus-blue hover:bg-blue-700 transition-colors duration-200">
                            <svg class="w-4 h-4 mr-2 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                            </svg>
                            Enviar Respuesta
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Sistema de Notificaciones Toast -->
<div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>
{% endblock %}

{% block extra_scripts %}
<style>
.line-clamp-2 {
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
}

/* Estilos para notificaciones toast */
.toast {
    min-width: 300px;
    max-width: 400px;
    padding: 16px;
    border-radius: 8px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    display: flex;
    align-items: center;
    gap: 12px;
    transform: translateX(100%);
    opacity: 0;
    transition: all 0.3s ease-in-out;
    position: relative;
    overflow: hidden;
}

.toast.show {
    transform: translateX(0);
    opacity: 1;
}

.toast.success {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
}

.toast.error {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
}

.toast.info {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: white;
}

.toast.warning {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    color: white;
}

.toast-icon {
    flex-shrink: 0;
    width: 20px;
    height: 20px;
}

.toast-content {
    flex: 1;
}

.toast-title {
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 4px;
}

.toast-message {
    font-size: 13px;
    opacity: 0.9;
    line-height: 1.4;
}

.toast-close {
    flex-shrink: 0;
    background: none;
    border: none;
    color: inherit;
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    transition: background-color 0.2s;
}

.toast-close:hover {
    background-color: rgba(255, 255, 255, 0.2);
}

.toast-progress {
    position: absolute;
    bottom: 0;
    left: 0;
    height: 3px;
    background-color: rgba(255, 255, 255, 0.3);
    transition: width linear;
}

/* Animaciones */
@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOutRight {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}
</style>
<script>
let currentMessageId = null;

// Sistema de Notificaciones Toast
function showToast(type, title, message, duration = 5000) {
    const container = document.getElementById('toastContainer');
    const toastId = 'toast-' + Date.now();
    
    const icons = {
        success: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
        error: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
        info: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
        warning: '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.268 18.5c-.77.833.192 2.5 1.732 2.5z"></path></svg>'
    };
    
    const toastHTML = `
        <div id="${toastId}" class="toast ${type}">
            <div class="toast-icon">${icons[type] || icons.info}</div>
            <div class="toast-content">
                <div class="toast-title">${title}</div>
                <div class="toast-message">${message}</div>
            </div>
            <button class="toast-close" onclick="removeToast('${toastId}')">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
            <div class="toast-progress" style="width: 100%;"></div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', toastHTML);
    
    const toast = document.getElementById(toastId);
    const progress = toast.querySelector('.toast-progress');
    
    // Mostrar toast
    setTimeout(() => {
        toast.classList.add('show');
    }, 100);
    
    // Iniciar barra de progreso
    setTimeout(() => {
        progress.style.width = '0%';
        progress.style.transition = `width ${duration}ms linear`;
    }, 100);
    
    // Auto-remover despu√©s de la duraci√≥n
    setTimeout(() => {
        removeToast(toastId);
    }, duration);
    
    return toastId;
}

function removeToast(toastId) {
    const toast = document.getElementById(toastId);
    if (toast) {
        toast.classList.remove('show');
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    }
}

// Funciones de conveniencia
function showSuccessToast(title, message, duration) {
    return showToast('success', title, message, duration);
}

function showErrorToast(title, message, duration) {
    return showToast('error', title, message, duration);
}

function showInfoToast(title, message, duration) {
    return showToast('info', title, message, duration);
}

function showWarningToast(title, message, duration) {
    return showToast('warning', title, message, duration);
}

// Cargar datos al iniciar
document.addEventListener('DOMContentLoaded', function() {
    console.log('P√°gina de mensajes cargada');
    const token = getAuthToken();
    console.log('Token disponible:', token ? 'S√≠' : 'No');
    
    loadMessageStats();
    loadMessages(1);
    
    // Enfocar autom√°ticamente el campo de b√∫squeda
    setTimeout(() => {
        const searchInput = document.getElementById('searchFilter');
        if (searchInput) {
            // Limpiar el campo de b√∫squeda antes de enfocar
            searchInput.value = '';
            searchInput.focus();
            console.log('Campo de b√∫squeda limpiado y enfocado autom√°ticamente');
        }
    }, 500); // Peque√±o delay para asegurar que la p√°gina est√© completamente cargada
    
    // Funci√≥n de prueba removida - no debe ejecutarse autom√°ticamente
    
    // Funci√≥n para inicializar el sistema de b√∫squeda
    function initializeMessageSearch() {
        console.log('üöÄ Inicializando sistema de b√∫squeda de mensajes...');
        
        // Asegurar que el campo de b√∫squeda est√© limpio
        const searchInput = document.getElementById('searchFilter');
        if (searchInput) {
            searchInput.value = '';
        }
        
        // Verificar que hay mensajes para buscar
        const messageCards = document.querySelectorAll('[data-search]');
        console.log('üìß Mensajes disponibles para b√∫squeda:', messageCards.length);
        
        if (messageCards.length === 0) {
            console.warn('‚ö†Ô∏è No hay mensajes disponibles para b√∫squeda');
            showWarningToast(
                'Sin Mensajes',
                'No hay mensajes disponibles para buscar. Carga algunos mensajes primero.',
                3000
            );
            return;
        }
        
        // Verificar que los mensajes tienen datos de b√∫squeda
        let messagesWithData = 0;
        messageCards.forEach((card, index) => {
            const searchData = card.getAttribute('data-search');
            if (searchData && searchData.trim().length > 0) {
                messagesWithData++;
            } else {
                console.warn(`‚ö†Ô∏è Mensaje ${index + 1} no tiene datos de b√∫squeda`);
            }
        });
        
        console.log(`üìä Mensajes con datos de b√∫squeda: ${messagesWithData}/${messageCards.length}`);
        
        if (messagesWithData === 0) {
            console.error('‚ùå Ning√∫n mensaje tiene datos de b√∫squeda configurados');
            showErrorToast(
                'Error de Configuraci√≥n',
                'Los mensajes no tienen datos de b√∫squeda configurados correctamente.',
                5000
            );
            return;
        }
        
        // Aplicar filtro inicial para mostrar todos los mensajes
        applyMessageFilter();
        
        console.log('‚úÖ Sistema de b√∫squeda de mensajes inicializado correctamente');
        
        showSuccessToast(
            'B√∫squeda Lista',
            `Sistema de b√∫squeda inicializado con ${messagesWithData} mensajes disponibles`,
            2000
        );
    }
    
    // Inicializar el sistema de b√∫squeda despu√©s de cargar los mensajes
    setTimeout(() => {
        initializeMessageSearch();
    }, 2000);
    
    // Event listeners
    // Nota: refreshButton no existe en esta p√°gina, se removi√≥
    
    document.getElementById('statusFilter').addEventListener('change', () => applyMessageFilter());
    document.getElementById('priorityFilter').addEventListener('change', () => applyMessageFilter());
    document.getElementById('typeFilter').addEventListener('change', () => applyMessageFilter());
    document.getElementById('searchFilter').addEventListener('input', debounce(function() {
        console.log('üîç Evento de b√∫squeda disparado');
        applyMessageFilter();
    }, 150));
    document.getElementById('unreadOnly').addEventListener('change', () => applyMessageFilter());
    document.getElementById('clearFilters').addEventListener('click', clearFilters);
    
    // Modal events
    document.getElementById('closeModal').addEventListener('click', closeModal);
    document.getElementById('cancelResponse').addEventListener('click', closeModal);
    document.getElementById('sendResponse').addEventListener('click', sendResponse);
});

function loadMessageStats() {
    const token = getAuthToken();
    
    if (!token) {
        console.error('No hay token de autenticaci√≥n disponible');
        return;
    }
    
    fetch('/api/messages/stats', {
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        document.getElementById('unreadMessages').textContent = data.unread_messages || 0;
        document.getElementById('pendingMessages').textContent = data.pending_messages || 0;
        document.getElementById('closedMessages').textContent = data.closed_messages || 0;
    })
    .catch(error => {
        console.error('Error cargando estad√≠sticas:', error);
        // Mostrar valores por defecto en caso de error
        document.getElementById('unreadMessages').textContent = '0';
        document.getElementById('pendingMessages').textContent = '0';
        document.getElementById('closedMessages').textContent = '0';
        
        // Mostrar notificaci√≥n de error solo si es un error de red
        if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
            showErrorToast(
                'Error de Conexi√≥n',
                'No se pudieron cargar las estad√≠sticas. Verifica tu conexi√≥n.',
                5000
            );
        }
    });
}

let currentPage = 1;
let currentLimit = 20;

function loadMessages(page = 1) {
    const token = getAuthToken();
    
    if (!token) {
        console.error('No hay token de autenticaci√≥n disponible');
        window.location.href = '/auth/login';
        return;
    }
    
    console.log('Cargando mensajes con token:', token ? 'presente' : 'ausente');
    
    document.getElementById('messagesLoading').classList.remove('hidden');
    document.getElementById('messagesList').innerHTML = '';
    document.getElementById('noMessages').classList.add('hidden');
    document.getElementById('pagination').classList.add('hidden');
    
    // Construir par√°metros de consulta
    const params = new URLSearchParams({
        page: page.toString(),
        limit: currentLimit.toString()
    });
    
    // Agregar filtros si est√°n aplicados
    const statusFilter = document.getElementById('statusFilter').value;
    const searchFilter = document.getElementById('searchFilter').value;
    const priorityFilter = document.getElementById('priorityFilter')?.value;
    const typeFilter = document.getElementById('typeFilter')?.value;
    const unreadOnly = document.getElementById('unreadOnly')?.checked;
    
    if (statusFilter) params.append('status', statusFilter);
    if (searchFilter) params.append('search', searchFilter);
    if (priorityFilter) params.append('priority', priorityFilter);
    if (typeFilter) params.append('message_type', typeFilter);
    if (unreadOnly) params.append('unread_only', 'true');
    
    fetch(`/api/messages/?${params.toString()}`, {
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Datos recibidos desde API:', data);
        currentPage = page;
        displayMessages(data.messages, data.pagination);
    })
    .catch(error => {
        console.error('Error cargando mensajes:', error);
        document.getElementById('messagesLoading').classList.add('hidden');
        document.getElementById('noMessages').classList.remove('hidden');
        
        // Mostrar mensaje de error
        const messagesList = document.getElementById('messagesList');
        messagesList.innerHTML = `
            <div class="text-center py-8">
                <div class="bg-red-100 rounded-lg p-3 inline-flex mx-auto mb-4">
                    <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-medium text-gray-900">Error al cargar mensajes</h3>
                <p class="mt-2 text-sm text-gray-500">No se pudieron cargar los mensajes. Intenta recargar la p√°gina.</p>
            </div>
        `;
    });
}

function displayMessages(messages, pagination = null) {
    document.getElementById('messagesLoading').classList.add('hidden');
    
    const messagesList = document.getElementById('messagesList');
    messagesList.innerHTML = '';
    
    if (messages.length === 0) {
        document.getElementById('noMessages').classList.remove('hidden');
    } else {
        messages.forEach(message => {
            const messageElement = createMessageElement(message);
            messagesList.appendChild(messageElement);
        });
        
        // Mostrar paginaci√≥n si est√° disponible
        if (pagination && pagination.total_pages > 1) {
            displayPagination(pagination);
        }
        
        // Inicializar filtrado local despu√©s de cargar mensajes
        setTimeout(() => {
            console.log('üîÑ Inicializando filtrado local despu√©s de cargar mensajes');
            applyMessageFilter();
        }, 200);
    }
    
    console.log('Mensajes mostrados exitosamente');
}

function displayPagination(pagination) {
    const paginationDiv = document.getElementById('pagination');
    paginationDiv.classList.remove('hidden');
    
    let paginationHTML = `
        <div class="flex items-center justify-between px-4 py-3 bg-white border-t border-gray-200 sm:px-6">
            <div class="flex justify-between flex-1 sm:hidden">
                ${pagination.has_prev ? `<button onclick="loadMessages(${pagination.page - 1})" class="relative inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">Anterior</button>` : ''}
                ${pagination.has_next ? `<button onclick="loadMessages(${pagination.page + 1})" class="relative ml-3 inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">Siguiente</button>` : ''}
            </div>
            <div class="hidden sm:flex sm:flex-1 sm:items-center sm:justify-between">
                <div>
                    <p class="text-sm text-gray-700">
                        Mostrando <span class="font-medium">${((pagination.page - 1) * pagination.limit) + 1}</span>
                        a <span class="font-medium">${Math.min(pagination.page * pagination.limit, pagination.total)}</span>
                        de <span class="font-medium">${pagination.total}</span> resultados
                    </p>
                </div>
                <div>
                    <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
    `;
    
    // Bot√≥n Anterior
    if (pagination.has_prev) {
        paginationHTML += `
            <button onclick="loadMessages(${pagination.page - 1})" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                <span class="sr-only">Anterior</span>
                <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                </svg>
            </button>
        `;
    }
    
    // N√∫meros de p√°gina
    const startPage = Math.max(1, pagination.page - 2);
    const endPage = Math.min(pagination.total_pages, pagination.page + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        const isCurrentPage = i === pagination.page;
        paginationHTML += `
            <button onclick="loadMessages(${i})" class="relative inline-flex items-center px-4 py-2 border text-sm font-medium ${isCurrentPage ? 'z-10 bg-papyrus-blue border-papyrus-blue text-white' : 'bg-white border-gray-300 text-gray-500 hover:bg-gray-50'}">
                ${i}
            </button>
        `;
    }
    
    // Bot√≥n Siguiente
    if (pagination.has_next) {
        paginationHTML += `
            <button onclick="loadMessages(${pagination.page + 1})" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                <span class="sr-only">Siguiente</span>
                <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                </svg>
            </button>
        `;
    }
    
    paginationHTML += `
                    </nav>
                </div>
            </div>
        </div>
    `;
    
    paginationDiv.innerHTML = paginationHTML;
}

function createMessageElement(message) {
    const div = document.createElement('div');
    const isUnread = !message.is_read;
    
    div.className = `bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-all duration-200 cursor-pointer ${isUnread ? 'border-blue-500 bg-blue-50' : ''}`;
    div.onclick = () => {
        console.log('Click en mensaje:', message.id);
        openMessageDetail(message.id);
    };
    
    // Agregar atributo data-search para filtrado local
    const searchData = [
        message.subject || '',
        message.content || '',
        message.customer_name || '',
        message.customer_phone || '',
        message.customer_email || '',
        message.package_guide_number || '',
        message.package_tracking_code || '',
        message.status || '',
        message.message_type || '',
        message.priority || ''
    ].join(' ').toLowerCase();
    
    div.setAttribute('data-search', searchData);
    
    const statusColor = getStatusColor(message.status);
    const statusText = getStatusText(message.status);
    const statusIcon = getStatusIcon(message.status);
    
    div.innerHTML = `
        <div class="flex items-start space-x-3">
            <div class="flex-shrink-0">
                <div class="bg-gray-100 rounded-lg p-2">
                    ${statusIcon}
                </div>
            </div>
            <div class="flex-1 min-w-0">
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <div class="flex items-center space-x-2 mb-1">
                            <h4 class="text-sm font-semibold text-gray-900 truncate" style="font-size: 14px !important;">${message.subject}</h4>
                            ${isUnread ? '<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-papyrus-red text-white">Nuevo</span>' : ''}
                        </div>
                        <p class="text-sm text-gray-700 line-clamp-2" style="font-size: 14px !important;">${message.content}</p>
                        <div class="mt-2 flex flex-wrap items-center gap-2 text-sm text-gray-500">
                            <span class="flex items-center">
                                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                </svg>
                                ${message.customer_name || 'Sistema'}
                            </span>
                            <span class="flex items-center">
                                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                ${formatDate(message.created_at)}
                            </span>
                            ${message.package_guide_number ? `
                            <span class="flex items-center">
                                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                                </svg>
                                ${message.package_guide_number}
                            </span>` : ''}
                        </div>
                    </div>
                    <div class="ml-4 flex-shrink-0">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-sm font-bold ${statusColor}">
                            ${statusText}
                        </span>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    return div;
}

function getTypeIcon(type) {
    switch(type) {
        case 'customer_inquiry':
            return '<svg class="w-6 h-6 text-papyrus-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
        case 'internal':
            return '<svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>';
        case 'support':
            return '<svg class="w-6 h-6 text-papyrus-green" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636l-3.536 3.536m0 5.656l3.536 3.536M9.172 9.172L5.636 5.636m3.536 9.192l-3.536 3.536M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-5 0a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>';
        case 'system':
            return '<svg class="w-6 h-6 text-papyrus-orange" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>';
        default:
            return '<svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>';
    }
}

function openMessageDetail(messageId) {
    console.log('Abriendo detalle del mensaje:', messageId);
    currentMessageId = messageId;
    
    const token = getAuthToken();
    
    if (!token) {
        console.error('No hay token de autenticaci√≥n disponible');
        window.location.href = '/auth/login';
        return;
    }
    
    // Mostrar loading en el modal
    const detailDiv = document.getElementById('messageDetail');
    detailDiv.innerHTML = `
        <div class="text-center py-8">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-papyrus-blue mx-auto"></div>
            <p class="mt-2 text-sm text-gray-500">Cargando mensaje...</p>
        </div>
    `;
    
    const modal = document.getElementById('messageModal');
    modal.classList.remove('hidden');
    
    fetch(`/api/messages/${messageId}`, {
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Datos del mensaje recibidos:', data);
        
        const statusColor = getStatusColor(data.status);
        const statusText = getStatusText(data.status);
        
        detailDiv.innerHTML = `
            <!-- Header con informaci√≥n b√°sica -->
            <div class="bg-gray-50 rounded-lg p-4 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-sm font-semibold text-gray-900">${data.subject}</h2>
                    <div class="flex items-center space-x-2">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-bold ${statusColor}">
                            ${statusText}
                        </span>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
                    <div class="flex items-center space-x-2">
                        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                        <span class="text-sm text-gray-700">${data.customer_name || 'Sin nombre'}</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                        </svg>
                        <span class="text-sm text-gray-700">${data.customer_phone || 'Sin tel√©fono'}</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                        </svg>
                        <span class="text-sm text-gray-700">${data.customer_email || 'Sin email'}</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span class="text-sm text-gray-700">${formatDate(data.created_at)}</span>
                    </div>
                </div>
            </div>
            
            ${data.package_guide_number || data.package_tracking_code ? `
            <!-- Informaci√≥n del paquete -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                <h3 class="text-sm font-medium text-gray-900 mb-3">Informaci√≥n del Paquete</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
                    ${data.package_guide_number ? `
                    <div>
                        <span class="text-gray-500">N√∫mero de Gu√≠a:</span>
                        <span class="ml-2 font-medium text-gray-900">${data.package_guide_number}</span>
                    </div>
                    ` : ''}
                    ${data.package_tracking_code ? `
                    <div>
                        <span class="text-gray-500">C√≥digo de Tracking:</span>
                        <span class="ml-2 font-medium text-gray-900">${data.package_tracking_code}</span>
                    </div>
                    ` : ''}
                </div>
            </div>
            ` : ''}
            
            <!-- Mensaje del cliente -->
            <div class="mb-6">
                <h3 class="text-sm font-medium text-gray-900 mb-3">Mensaje del Cliente</h3>
                <div class="bg-white border border-gray-200 rounded-lg p-4">
                    <p class="text-sm text-gray-700 whitespace-pre-wrap">${data.content}</p>
                </div>
            </div>
            
            ${data.admin_response ? `
            <!-- Respuesta del administrador -->
            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                <h3 class="text-sm font-medium text-gray-900 mb-3">Respuesta del Administrador</h3>
                <p class="text-sm text-gray-700 whitespace-pre-wrap mb-3">${data.admin_response}</p>
                <p class="text-xs text-gray-500">
                    <svg class="w-3 h-3 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    ${data.responded_by_name} - ${formatDate(data.responded_at)}
                </p>
            </div>
            ` : ''}
            
        `;
        
        // Mostrar/ocultar formulario de respuesta
        const responseForm = document.getElementById('responseForm');
        if (data.status === 'PENDING') {
            responseForm.classList.remove('hidden');
        } else {
            responseForm.classList.add('hidden');
        }
        
        console.log('Modal mostrado exitosamente');
    })
    .catch(error => {
        console.error('Error cargando detalle del mensaje:', error);
        detailDiv.innerHTML = `
            <div class="text-center py-8">
                <div class="bg-red-100 rounded-lg p-3 inline-flex mx-auto mb-4">
                    <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-medium text-gray-900">Error al cargar mensaje</h3>
                <p class="mt-2 text-sm text-gray-500">No se pudo cargar el detalle del mensaje.</p>
            </div>
        `;
    });
}

function sendResponse() {
    const responseText = document.getElementById('responseText').value.trim();
    
    if (!responseText) {
        showErrorToast(
            'Respuesta Vac√≠a',
            'Por favor escribe una respuesta antes de enviar.',
            3000
        );
        return;
    }
    
    if (responseText.length < 5) {
        showErrorToast(
            'Respuesta Muy Corta',
            'La respuesta debe tener al menos 5 caracteres.',
            3000
        );
        return;
    }
    
    if (responseText.length > 2000) {
        showErrorToast(
            'Respuesta Muy Larga',
            'La respuesta no puede exceder 2000 caracteres.',
            3000
        );
        return;
    }
    
    fetch(`/api/messages/${currentMessageId}/respond`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${getAuthToken()}`
        },
        body: JSON.stringify({
            response: responseText
        })
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(errorData => {
                throw new Error(`HTTP ${response.status}: ${errorData.detail || 'Error desconocido'}`);
            });
        }
        return response.json();
    })
    .then(data => {
        // Cerrar modal sin refresh autom√°tico (lo haremos manualmente)
        document.getElementById('messageModal').classList.add('hidden');
        document.getElementById('responseText').value = '';
        updateResponseCounter();
        currentMessageId = null;
        
        // Refresh manual para respuesta enviada
        loadMessageStats();
        loadMessages(currentPage);
        
        showSuccessToast(
            'Respuesta Enviada',
            'El mensaje ha sido cerrado autom√°ticamente.',
            4000
        );
    })
    .catch(error => {
        console.error('Error enviando respuesta:', error);
        showErrorToast(
            'Error al Enviar',
            error.message || 'No se pudo enviar la respuesta. Intenta nuevamente.',
            5000
        );
    });
}

function closeModal() {
    document.getElementById('messageModal').classList.add('hidden');
    document.getElementById('responseText').value = '';
    updateResponseCounter();
    
    // Refrescar autom√°ticamente la lista y estad√≠sticas al cerrar el modal
    // Esto asegura que los cambios de estado (le√≠do/no le√≠do) se reflejen inmediatamente
    loadMessageStats();
    loadMessages(currentPage);
    
    currentMessageId = null;
}

function updateResponseCounter() {
    const textarea = document.getElementById('responseText');
    const counter = document.getElementById('responseCounter');
    if (textarea && counter) {
        const length = textarea.value.length;
        counter.textContent = `${length}/2000`;
        
        // Cambiar color seg√∫n la longitud
        if (length < 5) {
            counter.className = 'absolute bottom-2 right-2 text-xs text-red-500 bg-white px-1 rounded';
        } else if (length > 1800) {
            counter.className = 'absolute bottom-2 right-2 text-xs text-orange-500 bg-white px-1 rounded';
        } else {
            counter.className = 'absolute bottom-2 right-2 text-xs text-gray-500 bg-white px-1 rounded';
        }
    }
}

function clearFilters() {
    document.getElementById('statusFilter').value = '';
    document.getElementById('priorityFilter').value = '';
    document.getElementById('typeFilter').value = '';
    document.getElementById('searchFilter').value = '';
    document.getElementById('unreadOnly').checked = false;
    
    // Aplicar filtrado local en lugar de recargar desde servidor
    applyMessageFilter();
    
    showInfoToast(
        'Filtros Limpiados',
        'Se han removido todos los filtros aplicados.',
        2000
    );
}

// Funci√≥n para filtrar por estado desde las tarjetas
function filterByStatus(status) {
    // Mapear los estados seg√∫n la nueva l√≥gica
    let filterStatus = '';
    switch(status) {
        case 'unread':
            filterStatus = 'unread'; // No Le√≠dos ‚Üí No Le√≠dos (no visualizados)
            break;
        case 'pending':
            filterStatus = 'pending'; // Pendientes ‚Üí Pendientes (visualizados sin respuesta)
            break;
        case 'closed':
            filterStatus = 'closed'; // Cerrados ‚Üí Cerrados (con respuesta)
            break;
    }
    
    // Establecer el filtro de estado
    document.getElementById('statusFilter').value = filterStatus;
    
    // Limpiar otros filtros para mostrar solo el estado seleccionado
    document.getElementById('priorityFilter').value = '';
    document.getElementById('typeFilter').value = '';
    document.getElementById('searchFilter').value = '';
    document.getElementById('unreadOnly').checked = false;
    
    // Aplicar filtrado local en lugar de recargar desde servidor
    applyMessageFilter();
    
    // Mostrar notificaci√≥n de filtro aplicado
    const statusNames = {
        'unread': 'NO LE√çDOS',
        'pending': 'PENDIENTES',
        'closed': 'CERRADOS'
    };
    
    showInfoToast(
        'Filtro Aplicado',
        `Mostrando solo mensajes: ${statusNames[filterStatus]}`,
        3000
    );
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}


function getStatusColor(status) {
    switch(status) {
        case 'UNREAD': return 'bg-blue-100 text-blue-600';
        case 'PENDING': return 'bg-red-100 text-red-600';
        case 'CLOSED': return 'bg-green-100 text-green-600';
        default: return 'bg-gray-100 text-gray-700';
    }
}

function getStatusText(status) {
    switch(status) {
        case 'UNREAD': return 'NO LE√çDO';
        case 'PENDING': return 'PENDIENTE';
        case 'CLOSED': return 'CERRADO';
        default: return status;
    }
}

function getStatusIcon(status) {
    switch(status) {
        case 'UNREAD':
            return '<svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path></svg>';
        case 'PENDING':
            return '<svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
        case 'CLOSED':
            return '<svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
        default:
            return '<svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>';
    }
}

function getPriorityColor(priority) {
    switch(priority) {
        case 'urgent': return 'bg-red-100 text-red-800';
        case 'high': return 'bg-orange-100 text-orange-800';
        case 'normal': return 'bg-blue-100 text-blue-800';
        case 'low': return 'bg-gray-100 text-gray-800';
        default: return 'bg-gray-100 text-gray-800';
    }
}

function getPriorityText(priority) {
    switch(priority) {
        case 'urgent': return 'Urgente';
        case 'high': return 'Alta';
        case 'normal': return 'Normal';
        case 'low': return 'Baja';
        default: return priority;
    }
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleDateString('es-CO', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// Funci√≥n para aplicar filtros locales a los mensajes
function applyMessageFilter() {
    console.log('üöÄ Iniciando applyMessageFilter...');
    
    const statusFilter = document.getElementById('statusFilter')?.value || '';
    const searchFilter = document.getElementById('searchFilter')?.value?.toLowerCase().trim() || '';
    const priorityFilter = document.getElementById('priorityFilter')?.value || '';
    const typeFilter = document.getElementById('typeFilter')?.value || '';
    const unreadOnly = document.getElementById('unreadOnly')?.checked || false;
    
    console.log('üîç Aplicando filtros locales:', { statusFilter, searchFilter, priorityFilter, typeFilter, unreadOnly });
    
    const messageCards = document.querySelectorAll('[data-search]');
    console.log('üìß Mensajes encontrados:', messageCards.length);
    
    if (messageCards.length === 0) {
        console.warn('‚ö†Ô∏è No se encontraron mensajes con atributo data-search');
        return;
    }
    
    let visibleCount = 0;
    
    messageCards.forEach((card, index) => {
        let shouldShow = true;
        
        // Filtrar por estado
        if (statusFilter && shouldShow) {
            const statusElement = card.querySelector('span[class*="bg-"]');
            const statusText = statusElement ? statusElement.textContent.trim() : '';
            
            const statusMap = {
                'unread': 'NO LE√çDO',
                'pending': 'PENDIENTE',
                'closed': 'CERRADO'
            };
            
            if (statusText !== statusMap[statusFilter]) {
                shouldShow = false;
                console.log(`‚ùå Mensaje ${index + 1} filtrado por estado: ${statusText} !== ${statusMap[statusFilter]}`);
            }
        }
        
        // Filtrar por b√∫squeda
        if (searchFilter && shouldShow) {
            const searchData = card.getAttribute('data-search') || '';
            const searchTerms = searchFilter.split(' ').filter(term => term.length > 0);
            
            console.log(`üìã Mensaje ${index + 1} - Datos de b√∫squeda:`, searchData);
            console.log(`üîç T√©rminos de b√∫squeda:`, searchTerms);
            
            const allTermsFound = searchTerms.every(term => {
                const found = searchData.includes(term.toLowerCase());
                console.log(`üîç T√©rmino "${term}" encontrado:`, found);
                return found;
            });
            
            if (!allTermsFound) {
                shouldShow = false;
                console.log(`‚ùå Mensaje ${index + 1} filtrado por b√∫squeda`);
            } else {
                console.log(`‚úÖ Mensaje ${index + 1} coincide con b√∫squeda`);
            }
        }
        
        // Filtrar por prioridad
        if (priorityFilter && shouldShow) {
            const searchData = card.getAttribute('data-search') || '';
            if (!searchData.includes(priorityFilter.toLowerCase())) {
                shouldShow = false;
            }
        }
        
        // Filtrar por tipo
        if (typeFilter && shouldShow) {
            const searchData = card.getAttribute('data-search') || '';
            if (!searchData.includes(typeFilter.toLowerCase())) {
                shouldShow = false;
            }
        }
        
        // Filtrar solo no le√≠dos
        if (unreadOnly && shouldShow) {
            if (!card.classList.contains('border-blue-500')) {
                shouldShow = false;
            }
        }
        
        // Mostrar/ocultar mensaje
        if (shouldShow) {
            card.style.display = 'block';
            visibleCount++;
            console.log(`‚úÖ Mensaje ${index + 1} visible`);
        } else {
            card.style.display = 'none';
            console.log(`‚ùå Mensaje ${index + 1} oculto`);
        }
    });
    
    console.log(`üìä Total de mensajes visibles: ${visibleCount}`);
    
    // Actualizar contador
    updateMessageCounter(visibleCount);
    
    // Mostrar mensaje si no hay mensajes visibles
    showNoMessagesMessage(visibleCount === 0);
}

// Funciones de resaltado removidas - solo se realiza b√∫squeda sin resaltar

// Funci√≥n para actualizar contador de mensajes
function updateMessageCounter(visibleCount) {
    const totalMessages = document.querySelectorAll('[data-search]').length;
    const counterElement = document.querySelector('.text-sm.text-gray-500');
    
    if (counterElement) {
        counterElement.textContent = `Mostrando ${visibleCount} de ${totalMessages} mensajes`;
    }
}

// Funci√≥n para mostrar mensaje cuando no hay mensajes visibles
function showNoMessagesMessage(show) {
    const noMessagesDiv = document.getElementById('noMessages');
    if (noMessagesDiv) {
        if (show) {
            noMessagesDiv.classList.remove('hidden');
        } else {
            noMessagesDiv.classList.add('hidden');
        }
    }
}

function getAuthToken() {
    // Intentar obtener token desde localStorage primero
    let token = localStorage.getItem('access_token');
    
    // Si no est√° en localStorage, intentar desde cookies
    if (!token) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; access_token=`);
        if (parts.length === 2) {
            token = parts.pop().split(';').shift();
        }
    }
    
    return token;
}

function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
}
</script>
{% endblock %}
